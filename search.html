<!doctype html>
<!-- Conditional comment for mobile ie7 blogs.msdn.com/b/iemobile/ -->
<!--[if IEMobile 7 ]>
<html class="no-js iem7" lang="en"> <![endif]-->
<!--[if (gt IEMobile 7)|!(IEMobile)]><!-->
<html class="no-js" lang="en"> <!--<![endif]-->

<head>
    <meta charset="utf-8">

    <title></title>
    <meta name="description" content="">

    <!-- Mobile viewport optimization h5bp.com/ad -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <!-- Home screen icon  Mathias Bynens mathiasbynens.be/notes/touch-icons -->
    <!-- For iPhone 4 with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="img/h/apple-touch-icon.png">
    <!-- For first-generation iPad: -->
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="img/m/apple-touch-icon.png">
    <!-- For non-Retina iPhone, iPod Touch, and Android 2.1+ devices: -->
    <link rel="apple-touch-icon-precomposed" href="img/l/apple-touch-icon-precomposed.png">
    <!-- For nokia devices: -->
    <link rel="shortcut icon" href="img/l/apple-touch-icon.png">

    <!-- iOS web app, delete if not needed. https://github.com/h5bp/mobile-boilerplate/issues/94 -->
    <!-- <meta name="apple-mobile-web-app-capable" content="yes">
         <meta name="apple-mobile-web-app-status-bar-style" content="black"> -->
    <!-- <script>(function(){var a;if(navigator.platform==="iPad"){a=window.orientation!==90||window.orientation===-90?"img/startup-tablet-landscape.png":"img/startup-tablet-portrait.png"}else{a=window.devicePixelRatio===2?"img/startup-retina.png":"img/startup.png"}document.write('<link rel="apple-touch-startup-image" href="'+a+'"/>')})()</script> -->

    <!-- The script prevents links from opening in mobile safari. https://gist.github.com/1042026 -->
    <!-- <script>(function(a,b,c){if(c in b&&b[c]){var d,e=a.location,f=/^(a|html)$/i;a.addEventListener("click",function(a){d=a.target;while(!f.test(d.nodeName))d=d.parentNode;"href"in d&&(d.href.indexOf("http")||~d.href.indexOf(e.host))&&(a.preventDefault(),e.href=d.href)},!1)}})(document,window.navigator,"standalone")</script> -->

    <!-- Mobile IE allows us to activate ClearType technology for smoothing fonts for easy reading -->
    <meta http-equiv="cleartype" content="on">

    <!-- more tags for your 'head' to consider h5bp.com/d/head-Tips -->

    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.css"/>
    <link rel="stylesheet" href="js/libs/leaflet/leaflet.css" />

    <!-- All JavaScript at the bottom, except for Modernizr which enables HTML5 elements & feature detects -->
    <script src="js/libs/modernizr-2.0.6.min.js"></script>
    <!-- Grab Google CDN's jQuery, with a protocol relative URL; fall back to local if necessary -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/libs/jquery-1.7.1.min.js"><\/script>')</script>
    <script src="js/libs/jquery.mobile-1.1.0.js"></script>

</head>

<body>
<!-- Templating html -->
<textarea id="path-result-item-template" style="display: none;">
    <% _.each(paths,function (path) { %>
    <li>
        <a onclick="extend_data(<%=path.id%>)" href="#three">
            <img class="ui-li-icon" src="<%=path.favicon%>" width="25" height="25">
            <%=path.title%>&nbsp;(<%=path.time%>)
        </a>
    </li>
    <% }); %>
</textarea>

<textarea id="path-steps-detail" style="display: none;">
    <% _.each(steps,function (steps) { %>
        <li> <%=steps.text%></li>
    <% }); %>
</textarea>
<!-- //Templating html -->

<div id="container">

    <header>
        <h1>Loading Yeca...</h1>
    </header>

    <!-- Start of first page: #one -->
    <div data-role="page" id="one">
        <div data-role="header" data-theme="d">
            <div class="header-logo">
                <img src="marketing/logo.png" >
            </div>
        </div>
        <!-- /header -->

        <div data-role="content">

            <form action="#">

                <!--<div class="ui-block-a" data-inline="true">-->
                <div>
                    <p>
                    <label for="from-input" class="ui-hidden-accessible">Desde</label>
                    <input type="text" name="from-string" id="from-input" placeholder="Desde donde estoy" data-mini="true" disabled/>
                    </p>

                    <p>
                    <label for="to-input" class="ui-hidden-accessible">Hasta</label>
                    <input type="text" name="from-string" id="to-input" placeholder="Hasta" data-mini="true" disabled/>
                    </p>

                    <p><a id="go-button" href="#two" data-transition="slide" data-role="button" data-icon="arrow-r"
                          data-iconpos="right" data-mini="true">Comparar opciones</a></p>
                </div>

            </form>

            <div id="map-container-1"><div id="map"></div></div>

        </div>
        <!-- /content -->

    </div>
    <!-- /page one -->

    <!-- Start of second page: #two -->
    <div data-role="page" id="two">
        <div data-role="header" data-theme="d">
            <div class="header-logo">
                <img src="marketing/logo.png" >
            </div>
        </div>
        <!-- /header -->

        <div data-role="content">

            <div id="map-container-2"></div>

            <small><a
                    href="http://maps.google.com/maps?f=q&amp;source=embed&amp;hl=es&amp;geocode=&amp;q=Algarrobo+1001,+Ciudad+Aut%C3%B3noma+de+Buenos+Aires,+Argentina&amp;aq=0&amp;oq=algarrobo+10&amp;sll=-34.603723,-58.381593&amp;sspn=0.280328,0.676346&amp;t=h&amp;ie=UTF8&amp;hq=&amp;hnear=Algarrobo+1001,+Barracas,+Buenos+Aires,+Argentina&amp;z=14&amp;ll=-34.65435,-58.379507"
                    style="color:#0000FF;text-align:left">Ver mapa m√°s grande</a></small>

            <ul id="search-result-list" data-role="listview" data-theme="c">
                <!-- Here must be the list of possible paths -->
            </ul>

            <p>
                <a href="#one" data-transition="slide" data-role="button">Volver a buscar</a>
            </p>

        </div>
        <!-- /content -->
        <div data-role="footer" data-theme="d">
            <h4>Footer</h4>
        </div>
    </div>
    <!-- /page two -->

    <!-- Start of second page: #three -->
    <div data-role="page" id="three">

        <div data-role="header" data-theme="d">
            <div class="header-logo">
                <img src="marketing/logo.png" >
            </div>
        </div>
        <!-- /header -->

        <div data-role="content">
            <h2>Detalle del recorrido:</h2>
            <br/>
            <div id="data">
                <ol>

                </ol>
            </div>

            <!--
            <ul id="search-result-list" data-role="listview" data-theme="c">
                <!-- Here must be the list of possible paths --
            </ul>
            -->

            <p>
                <a href="#two" data-transition="slide" data-role="button">Volver</a>
            </p>

        </div>
        <!-- /content -->
        <div data-role="footer" data-theme="d">
            <h4>Footer</h4>
        </div>
    </div>
    <!-- /page two -->

    <footer>
        This is the footer
    </footer>

</div>
<!--! end of #container -->

<!-- JavaScript at the bottom for fast page loading -->

<!-- USIG API -->
<script src="http://servicios.usig.buenosaires.gob.ar/usig-js/dev/usig.AutoCompleterFull.min.js"
        type="text/javascript"></script>
<script src="http://servicios.usig.buenosaires.gob.ar/usig-js/dev/usig.Recorridos.min.js"
        type="text/javascript"></script>

<!-- Underscore.js -->
<script src="js/underscore-1.3.3.js"></script>

<!-- Leaflet -->
<script src="js/libs/leaflet/leaflet.js"></script>
<script src="js/libs/proj4js-compressed.js"></script>
<script src="js/libs/proj4leaflet.js"></script>
<script src="js/leaflet-test.js"></script>

<!-- scripts concatenated and minified via ant build script-->
<script src="js/helper.js"></script>
<script src="js/script.js"></script>
<!-- end scripts-->

<script type="text/javascript">

    var icons = {
        "walk":"img/Icons/Transport/pedestriancrossing.png",
        "car":"img/Icons/Transport/car.png",
        "bus":"img/Icons/Transport/bus.png",
        "train":"img/Icons/Transport/tramway.png",
        "subway":"img/Icons/Transport/underground.png",
        "cycle":"img/Icons/Transport/cycling.png",
        "transporte_publico":"img/Icons/Transport/underground.png"
    };

    var detect_bus = /^\d/;
    var detect_train = /^F\.C\./;
    var paths;

    function extend_data(id) {
        var path = paths[id];

        path.getDetalle(function (detalle) {

                    var detailSteps = $(detalle).map(function () {
                        return {
                            text:this.text
                        }
                    });

                    var stepsHtml = _.template($("#path-steps-detail").text(), {steps:detailSteps});
                    $("#data ol").append($(stepsHtml));

                },

                function () {
                    alert('Se produjo un error al intentar cargar los detalles del recorrido.');
                });
    }

    function show_paths(found) {
        paths = found;

        $(paths).each(function (index, v) {
            var tipo = v.getTipo();
            v.desc = tipo == 'walk' ? 'Caminando' : tipo == 'car' ? 'En auto' : v.toString();
            v.tipo = tipo != 'transporte_publico' ? tipo : v.desc.match(detect_bus) ? 'bus' : v.desc.match(detect_train) ? 'train' : 'subway';
        });

        var posiblePaths = $(paths).map(function (index, p) {
            return {
                id:index,
                title:p.desc,
                favicon:icons[p.tipo],
                time:p.time_string()
            }
        });

        var directionsHtml = _.template($("#path-result-item-template").text(), {paths:posiblePaths});
        $("#search-result-list").empty().append($(directionsHtml));
        $("#search-result-list").listview('refresh');

    }

    function search_paths(from, to, success, error) {
        var full_results = [];
        var types = ['transporte', 'auto', 'pie'];
        var process_next = function (results) {
            full_results = full_results.concat(results);
            var type = types.pop();
            if (type) {
                usig.Recorridos.opts.tipo = type;
                usig.Recorridos.buscarRecorridos(from, to, process_next);
            } else {
                full_results.sort(function (a, b) {
                    return a.getTime() - b.getTime();
                });
                success(full_results);
            }
        };
        process_next([]);
    }

    $(function () {
        search_paths(
                new usig.Punto(107577.429171, 100133.783044),
                new usig.Punto(106846.501267, 101724.82835),
                show_paths,
                function () {
                    alert("error");//$('#recorridos').html('Se produjo un error el buscar el recorrido.');
                });

        $("#go-button").bind("click tap", function() {
            Yeca.searchPaths(function(paths) {
                // TODO Validar que tengo origin y destination
                $.mobile.changePage($("#two"));
                $("#map").appendTo("#map-container-2");
                show_paths(paths);
            });
        });

        Yeca.init();

        function initAutocompleter(id, afterSelectionCb, afterGeocodingCb) {
            new usig.AutoCompleter(id, {
                        skin:'dark',
                        onReady:function () {
                            $('#' + id).val('').removeAttr('disabled');
                        },
                        afterSelection: afterSelectionCb,
                        afterGeoCoding: afterGeocodingCb
                    });
        }

        initAutocompleter(
                'from-input',
                function (option) {
                    if (option instanceof usig.Direccion || option instanceof usig.inventario.Objeto) {
                        Yeca.origin = option;
                    }
                },
                function (pt) {
                    if (pt instanceof usig.Punto) {
                        if (Yeca.origin instanceof usig.Direccion) {
                            Yeca.origin.setCoordenadas(pt);
                        }
                    }
                }
        );

        $("#from-input").bind("blur", function() {
            var value = $(this).value();
        });

        initAutocompleter(
                'to-input',
                function (option) {
                    if (option instanceof usig.Direccion || option instanceof usig.inventario.Objeto) {
                        Yeca.destination = option;
                    }
                },
                function (pt) {
                    if (pt instanceof usig.Punto) {
                        if (Yeca.destination instanceof usig.Direccion) {
                            Yeca.destination.setCoordenadas(pt);
                        }
                    }
                }
        );

        function resizeMap() {
            if ($.mobile.activePage.attr("id") == "one") {
                $("#map").height(
                        $("html").height() - $("#one .ui-header").outerHeight(true)
                                - $("#one .ui-content").outerHeight(true) + $("#one .ui-content").height()
                                - $("#one form").outerHeight(true)
                );
                if (!Yeca.isIOS()) {
                    $("#map").height($("#map").height() - ($("#one").height() - $("html").height()));
                }
            } else if ($.mobile.activePage.attr("id") == "two") {

            }
        }

        resizeMap();
        $(window).bind("resize orientationchange", resizeMap);

    });

</script>

<!-- Debugger - remove for production -->
<!-- <script src="https://getfirebug.com/firebug-lite.js"></script> -->

<!-- Asynchronous Google Analytics snippet. Change UA-XXXXX-X to be your site's ID.
mathiasbynens.be/notes/async-analytics-snippet -->
<script>
    var _gaq = [
        ["_setAccount", "UA-XXXXX-X"],
        ["_trackPageview"]
    ];
    (function (d, t) {
        var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
        g.async = 1;
        g.src = ("https:" == location.protocol ? "//ssl" : "//www") + ".google-analytics.com/ga.js";
        s.parentNode.insertBefore(g, s)
    }(document, "script"));
</script>

</body>
</html>
